var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,l=(t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,o=(e,t)=>{for(var a in t||(t={}))i.call(t,a)&&l(e,a,t[a]);if(s)for(var a of s(t))r.call(t,a)&&l(e,a,t[a]);return e},n=(e,s)=>t(e,a(s));/* empty css             */import{_ as c,a as d,b as u,c as m,u as g}from"./user-origin-6f43f4e2.js";import{_ as h}from"./DynamicTextarea-2d8e7f4d.js";import{_ as p,a as f}from"./CommonCardSwiper-b51463fd.js";import{m as y,C as b,K as v,r as I,a8 as w,aI as x,o as M,c as S,e as A,D as k,E as V,aw as L,a as j,d as C,F as D,f as O,s as P,w as R,t as H,h as B,x as N}from"./vendor-c1c40a3c.js";import{_ as $,x as E,q as T,y as _,z as F,A as U,B as K,C as z,D as q}from"./index-36166ff4.js";import"./AddLove-9ac46bcb.js";import"./tippy.esm-b6ce9822.js";import"./index-3f4a165a.js";import"./pagination.min-91b3c22c.js";const Y={name:"ArticleCommon",components:{KiruAuthor:c,KiruInfo:d,CommonCard:p,CommonCardSwiper:f,KiruReply:u,SubscribeView:m,DynamicTextarea:h},beforeRouteUpdate(e,t){e.params.articleId!==t.params.articleId&&this.$store.commit("SHOW_OVERLAY_LOADING"),this.getArticleInfo(this.articleId)},props:{articleId:{type:[String,Number],default:""},loveCount:{type:[String,Number],default:0},isAddLove:{type:Boolean,default:!1},isCollect:{type:Boolean,default:!1}},emits:["author-info","add-love","add-collection","is-add-love"],data:()=>({articleVm:{},authorInfo:{},artArtlog:"",relatedArticleVm:{nowpage:1,showcount:3},relatedArticle:[],userMessageVm:"",messagePagination:{nowpage:1,showcount:9999},messageSettings:{pageSize:5,currentPage:1,loadCount:5,total:0,topNewDate:!0},articleMessage:[],sortMessage:[],messageTotal:0,userDefaultAvatar:g,isArticleVmLoading:!1,checkSubResult:!1,isSendingMessage:!1}),computed:n(o(o({},y(["userInfo","userAddLoveList","userKiruCollections","userSubscribeList","checkUserSubscribeStatus"])),b(["userSignInStatus"])),{loadMessage(){const e=this.messageSettings;let t=[];t=e.topNewDate?[...this.articleMessage].sort(((e,t)=>v(t.messageInitDate).format("x")-v(e.messageInitDate).format("x"))):[...this.articleMessage].sort(((e,t)=>v(e.messageInitDate).format("x")-v(t.messageInitDate).format("x")));const a=(e.currentPage-1)*e.loadCount;return t.slice(0,e.pageSize+a)},showLoadMessageBtn(){return this.articleMessage.length>this.messageSettings.pageSize&&this.loadMessage.length<this.articleMessage.length},articleAuthor(){const{author:e,authorPic:t,username:a}=this.articleVm;return{author:e,authorPic:t,username:a}},articleInfo(){const{title:e,introduction:t,articlecategoryId:a,artInitDate:s}=this.articleVm;return{title:e,introduction:t,articlecategoryId:a,artInitDate:s}}}),watch:{"articleVm.articlecategoryId":{handler(e){e&&this.getRelatedArticle(e)}},userSubscribeList:{handler(){this.checkSubResult=this.checkSub(this.articleVm.username)},deep:!0}},mounted(){this.getArticleInfo(this.articleId)},methods:{checkSub(e){const t=this.userSubscribeList.some((t=>t.username===e)),a=this.userInfo.Username===e;return t||a},async getArticleInfo(e){let t=!0;if(await E(e).then((e=>{var a;if(e.data.success){if(this.checkSub(e.data.data.username)&&(this.checkSubResult=!0),!e.data.data.isPush&&e.data.data.username!==(null==(a=this.userInfo)?void 0:a.Username))return this.$router.replace({name:"NotFound",query:{message:"此文章尚未發布"}}),void(t=!1);this.articleVm=e.data.data,this.isArticleVmLoading=!0}else this.$router.replace({name:"NotFound",query:{message:e.data.message||"查無此文章"}})})).catch((e=>{})),!t)return!1;await T(this.articleVm.username).then((e=>{e.data.success?(this.authorInfo=e.data.data,this.$emit("author-info",n(o({},this.authorInfo),{loveCount:this.articleVm.lovecount,isAddLove:this.isAddLove})),this.checkAddLoveStatus()):this.$notify({group:"error",title:"作者資訊取得失敗"})})),await _(this.articleVm.articlecategoryId).then((e=>{this.artArtlog=e.data.Name})).catch((e=>{}));const a=o({artId:this.articleId},this.messagePagination);await F(a).then((e=>{e.data.success?(this.articleMessage=e.data.data,this.messageTotal=e.data.total||this.articleMessage.length):this.articleMessage=[]})).catch((e=>{})),this.$store.commit("HIDE_OVERLAY_LOADING")},getRelatedArticle(e){U(o({articlecategoryId:e},this.relatedArticleVm)).then((e=>{if(e.data.success){const t=e.data.data.filter((e=>Number(this.articleId)!==e.artId));this.relatedArticle=t}else this.$notify({group:"error",title:"相關文章資料取得失敗"})})).catch((e=>{}))},checkAddLoveStatus(){-1!==this.userAddLoveList.findIndex((e=>e.articleId===this.articleId))&&this.$emit("is-add-love",!0)},addLoveHandler(e){this.$emit("add-love",e)},addCollectionHandler(){this.$emit("add-collection")},async sendMessageHandler(){if(""===this.userMessageVm||this.isSendingMessage)return;this.isSendingMessage=!0;const e={artId:this.articleId,Main:this.userMessageVm};await K(e).then((e=>{this.userMessageVm="",this.isSendingMessage=!1})).catch((e=>{this.isSendingMessage=!1}));const t=o({artId:this.articleId},this.messagePagination);await F(t).then((e=>{if(e.data.success){const t=e.data.data;this.updateMessage(t),this.messageTotal=e.data.total||this.articleMessage.length}else this.$notify({group:"error",title:"留言內容取得失敗"})})).catch((e=>{}))},updateMessage(e){this.articleMessage=e},async replyHandler(e){try{await z(e).then((e=>{})).catch((e=>{}));const t=o({artId:this.articleId},this.messagePagination),a=await q(e.messageId),s=await F(t);if(a.data.success)if(s.data.success){this.updateMessage(s.data.data);const t=this.articleMessage.findIndex((t=>t.messageId===e.messageId)),i=this.articleMessage[t].reMessageData.map((e=>e.reMessageId)),r=a.data.data;r.filter((e=>-1===i.indexOf(e.reMessageId))).forEach((e=>{this.articleMessage[t].reMessageData.push(e)}))}else this.$notify({group:"error",title:"留言內容取得失敗"});else this.$notify({group:"error",title:"回覆內容取得失敗"})}catch(t){}}}},G=C("div",{class:"px-4 mb-8"},[C("div",{class:"border-b border-black/10"})],-1),W={key:0,class:"mx-auto mb-8 max-w-[80%]"},J={key:1,class:"px-4 mb-32 w-full"},Q=["innerHTML"],X=C("div",{class:"flex justify-center mb-4 md:justify-between"},[C("div",{class:"py-2"},[C("h2",{class:"text-2xl font-bold text-myBrown"}," 相關文章 ")])],-1),Z={class:"mb-16 md:mb-32"},ee={key:0,class:"hidden grid-cols-2 grid-flow-row gap-6 md:grid md:grid-cols-3"},te={key:1,class:"py-2"},ae=[C("p",{class:"text-center text-myBrown/60"}," 沒有相關的文章 ",-1)],se={key:2},ie={key:2,"element-loading-background":"rgba(0, 0, 0, 0.5)","element-loading-text":"正在送出留言...",class:"flex overflow-hidden gap-8 justify-between py-4 px-6 mb-12 rounded-lg"},re={class:"overflow-hidden w-16 h-16 rounded-full"},le={alt:"",class:"object-cover w-full h-full scale-[102%] load"},oe={class:"flex flex-col grow gap-3 justify-between items-end md:flex-row"},ne=[C("span",{class:"inline-block text-lg md:-translate-y-1 material-icons"},"reply",-1),C("span",{class:"text-sm whitespace-nowrap md:-translate-y-1"},"送出",-1)],ce={key:3,class:"mb-12"},de={class:"flex justify-center items-center py-6 bg-myYellow/20"},ue=N(" 登入後留言 "),me={key:4,id:"article-replies",class:"mb-16"},ge={class:"flex justify-between px-6"},he={class:"text-black/60"},pe={key:0},fe={key:1,class:"px-6"};var ye=$(Y,[["render",function(e,t,a,s,i,r){var l;const o=c,n=d,g=m,y=p,b=f,v=h,N=I("router-link"),$=u,E=w("src"),T=x;return M(),S(D,null,[A(o,k(r.articleAuthor,{"love-count":a.loveCount,"is-add-love":a.isAddLove,"replies-count":i.messageTotal,"is-collect":a.isCollect,"article-type":"common",onAddLove:r.addLoveHandler,onAddCollection:r.addCollectionHandler}),null,16,["love-count","is-add-love","replies-count","is-collect","onAddLove","onAddCollection"]),A(n,k({class:"p-4 w-full"},r.articleInfo,{"art-artlog":i.artArtlog,"kiru-count":null==(l=i.articleVm.mArrayList)?void 0:l.length,"show-cover":!1}),null,16,["art-artlog","kiru-count"]),G,i.articleVm.isFree||i.checkSubResult||!i.isArticleVmLoading?j("",!0):(M(),S("div",W,[A(g,V(L(i.authorInfo)),null,16)])),i.articleVm.isFree||i.checkSubResult?(M(),S("div",J,[C("p",{innerHTML:i.articleVm.main},null,8,Q)])):j("",!0),X,C("div",Z,[0!==i.relatedArticle.length?(M(),S("div",ee,[(M(!0),S(D,null,O(i.relatedArticle,(e=>(M(),B(y,k(e,{key:e.artId}),null,16)))),128))])):(M(),S("div",te,ae)),0!==i.relatedArticle.length?(M(),S("div",se,[A(b,{key:"relative-common",class:"block md:hidden","common-info":i.relatedArticle},null,8,["common-info"])])):j("",!0)]),e.userSignInStatus&&(i.articleVm.isFree||i.checkSubResult)?P((M(),S("div",ie,[C("div",re,[P(C("img",le,null,512),[[E,e.userInfo.Userpic?"https://kirukiru.rocket-coding.com/Pic/"+e.userInfo.Userpic:i.userDefaultAvatar]])]),C("div",oe,[A(v,{modelValue:i.userMessageVm,"onUpdate:modelValue":t[0]||(t[0]=e=>i.userMessageVm=e),modelModifiers:{trim:!0},class:"w-full h-full",placeholder:"我要留言",onEnterExact:r.sendMessageHandler},null,8,["modelValue","onEnterExact"]),C("button",{type:"button",class:"flex gap-1 justify-center items-center py-1 px-4 text-white bg-myBrown md:flex-col md:py-0 md:px-2 md:h-full md:transition-all",onClick:t[1]||(t[1]=(...e)=>r.sendMessageHandler&&r.sendMessageHandler(...e))},ne)])])),[[T,i.isSendingMessage]]):j("",!0),e.userSignInStatus||!i.articleVm.isFree&&!i.checkSubResult?j("",!0):(M(),S("div",ce,[C("div",de,[A(N,{class:"block text-myBrown underline decoration-myBrown/60 underline-offset-4 transition-all",to:{name:"SignIn"}},{default:R((()=>[ue])),_:1})])])),i.articleVm.isFree||i.checkSubResult?(M(),S("div",me,[C("div",ge,[C("span",he,"此文共有 "+H(i.messageTotal)+" 筆留言",1),C("button",{type:"button",class:"text-sm text-myBrown/40 hover:text-myBrown/60",onClick:t[2]||(t[2]=e=>i.messageSettings.topNewDate=!i.messageSettings.topNewDate)},H(i.messageSettings.topNewDate?"留言時間 新 → 舊":"留言時間 舊 → 新"),1)]),0!==i.articleMessage.length?(M(),S("ul",pe,[(M(!0),S(D,null,O(r.loadMessage,(e=>(M(),B($,k(e,{key:e.messageId,"article-username":i.articleVm.username,onReplyInner:r.replyHandler}),null,16,["article-username","onReplyInner"])))),128))])):j("",!0),r.showLoadMessageBtn?(M(),S("div",fe,[C("button",{type:"button",class:"block py-4 mx-auto w-1/2 text-sm text-myBrown bg-myOrange/20 hover:bg-myOrange/40 rounded-xl transition-all",onClick:t[3]||(t[3]=e=>i.messageSettings.currentPage+=1)}," 查看更多留言 ("+H(i.articleMessage.length-r.loadMessage.length)+") ",1)])):j("",!0)])):j("",!0)],64)}]]);export{ye as default};
